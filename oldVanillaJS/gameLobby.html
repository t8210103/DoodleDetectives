<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h1>AI game - page 2</h1>
    <button id="btnCheck">Submit to AI</button>
    <script>
        // catch URL parsed payload - MAKE this work
        
        
        const myURL = new URL(window.location.href);
        const payload = JSON.parse(myURL.searchParams.get("payload"));

       /* const urlParams = new URLSearchParams(window.location.search);
        const encodedPayload = urlParams.get('payload');
        const decodedPayload = decodeURIComponent(encodedPayload);
        const payload = JSON.parse(decodedPayload); */
        
        let gameSocket = new WebSocket("ws://localhost:9090");
        console.log('payload:', payload);

 


        var drawing = document.getElementById("drawing");
        let base64String = null;
        let attempt = null;

        btnCheck.addEventListener("click", e => {

            // Here implement the translation from drawing to base64String

            const payload = {
                "method": "check",
                "clientId": clientId,
                "gameId": gameId,
                "base64String": base64String
            }

            gameSocket.send(JSON.stringify(payload));
        })

        gameSocket.onmessage = message => {
            const response = JSON.parse(message.data);

            if (response.method === "connect") {
                gameSocket.send(JSON.stringify(payload));
            }

            if (response.method === "join") { //Make interface of lobby - MAKE DYNAMIC
                const game = response.game;
                const clientId = response.clientId;

                if (game.clients.length < game.players) {

                    const div = document.createElement("div");
                    div.classList.add("awaitPlayers");
                    div.textContent = `Waiting for ${game.players - game.clients.length} more players to join...`;

                    const payload = {
                        "method": "waitPlayers",
                        "game": game,
                        "clientId": clientId
                    }

                    gameSocket.send(JSON.stringify(payload));

                } else {

                    const payload = {
                        "method": "play",
                        "game": game,
                        "clientId": clientId
                    }

                    window.location.href = `gameLobby.html?payload=${encodeURIComponent(payload)}`;
                }


            }

            if (response.method === "check") {
                attempt = response.attempt;
                if (attempt) {
                    console.log("You won!"); //implement winning senario
                } else {
                    console.log("What is this drawing dude?");
                }
            }

        }
    </script>
</body>
</html>